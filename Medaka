ARG IMAGE=nvidia/cuda:9.2-cudnn7-devel-ubuntu18.04

FROM $IMAGE

ENV PATH=/opt/medaka/venv/bin:$PATH
ENV MEDAKA_VERSION=1.0.1
ENV MINIMAP2_VERSION=2.17
ENV SAMTOOLS_VERSION=1.7
ENV HTSLIB_VERSION=1.9

RUN apt-get update && apt-get install -y \
       git \
       git-lfs \
       bzip2 \
       gcc \
       g++ \
       cmake \
       zlib1g-dev \
       libbz2-dev  \
       liblzma-dev \
       libffi-dev \
       libncurses5-dev \
       libcurl4-gnutls-dev \
       libssl-dev \
       curl \
       make \
       tabix \
       wget \
       python3-all-dev \
       python3-pip \
       python-virtualenv

RUN git lfs install

WORKDIR /opt

RUN wget https://github.com/samtools/htslib/releases/download/${HTSLIB_VERSION}/htslib-${HTSLIB_VERSION}.tar.bz2 && \
    tar -vxjf htslib-${HTSLIB_VERSION}.tar.bz2 && \
    cd htslib-${HTSLIB_VERSION} && \
    make

RUN wget https://github.com/samtools/samtools/releases/download/${SAMTOOLS_VERSION}/samtools-${SAMTOOLS_VERSION}.tar.bz2 && \
    tar -vxjf samtools-${SAMTOOLS_VERSION}.tar.bz2 && \
    cd samtools-${SAMTOOLS_VERSION} && \
    make

RUN curl -L https://github.com/lh3/minimap2/releases/download/v${MINIMAP2_VERSION}/minimap2-${MINIMAP2_VERSION}_x64-linux.tar.bz2 | tar -jxvf - && \
    ln -s /software/minimap2-${MINIMAP2_VERSION}_x64-linux/minimap2 /usr/bin


RUN git clone https://github.com/nanoporetech/medaka medaka && \
    cd medaka && make install

RUN apt-get clean